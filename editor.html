<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© - Ø§Ù„Ù…ÙˆÙ†ØªÙŠØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h3 class="text-center mb-4">ğŸ¬ ØµÙØ­Ø© Ø§Ù„Ù…ÙˆÙ†ØªÙŠØ± - Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª</h3>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
  <div class="mb-4">
    <label for="dateSelect" class="form-label">ğŸ“… Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®:</label>
    <input type="date" id="dateSelect" class="form-control" onchange="loadDayData()">
  </div>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® -->
  <form id="editorForm" class="d-none">
    <div class="row g-3" id="editorList"></div>
    <div class="text-center mt-4">
      <button class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©</button>
    </div>
  </form>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBvNRBl3cObiLC7GufXyCnF6BlKLM3oWXw",
    authDomain: "register-app-534bf.firebaseapp.com",
    databaseURL: "https://register-app-534bf-default-rtdb.firebaseio.com",
    projectId: "register-app-534bf",
    projectNumber: "1042312911162"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let entriesArray = [];
  let currentDate = "";

  function loadDayData() {
    currentDate = document.getElementById("dateSelect").value;
    document.getElementById("editorForm").classList.remove("d-none");
    entriesArray = [];

    db.ref(`attendance/${currentDate}`).once("value", snapshot => {
      const data = snapshot.val();
      const container = document.getElementById("editorList");
      container.innerHTML = "";

      if (!data) {
        container.innerHTML = `<p class="text-muted text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</p>`;
        return;
      }

      Object.entries(data).forEach(([key, entry], index) => {
        entriesArray.push({ key, ...entry });

        db.ref(`editingStatus/${currentDate}/${key}`).once("value", statusSnap => {
          const status = statusSnap.val() || {};
          const col = document.createElement("div");
          col.className = "col-md-6";

          const currentEditor = status.editor || "";

          col.innerHTML = `
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h5 class="card-title mb-1">${entry.name}</h5>
                    <p class="card-text mb-2">â° Ø¯Ø®ÙˆÙ„: ${entry.timeIn || "-"} - ğŸšª Ø®Ø±ÙˆØ¬: ${entry.timeOut || "-"}</p>
                  </div>
                  <div class="ms-3" style="min-width:180px;">
                    <label for="editor_${index}" class="form-label mb-1">ğŸ§‘ğŸ»â€ğŸ’» Ø§Ù„Ù…ÙˆÙ†ØªÙŠØ±</label>
                    <select id="editor_${index}" class="form-select form-select-sm">
                      <option value="" ${currentEditor==="" ? "selected" : ""}>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ†ØªÙŠØ±</option>
                      <option value="ØµÙ„Ø§Ø­" ${currentEditor==="ØµÙ„Ø§Ø­" ? "selected" : ""}>ØµÙ„Ø§Ø­</option>
                      <option value="Ù…Ø±ØªØ¶Ù‰" ${currentEditor==="Ù…Ø±ØªØ¶Ù‰" ? "selected" : ""}>Ù…Ø±ØªØ¶Ù‰</option>
                      <option value="Ù…Ø­Ù…Ø¯" ${currentEditor==="Ù…Ø­Ù…Ø¯" ? "selected" : ""}>Ù…Ø­Ù…Ø¯</option>
                    </select>
                  </div>
                </div>

                <hr class="my-3">

                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="edited_${index}" ${status.edited ? "checked" : ""}>
                  <label class="form-check-label" for="edited_${index}">âœ… ØªÙ…Øª Ø§Ù„Ù…Ù†ØªØ¬Ø©</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="filmed_${index}" ${status.filmed ? "checked" : ""}>
                  <label class="form-check-label" for="filmed_${index}">ğŸ¥ ØªÙ… Ø§Ù„ØªØµÙˆÙŠØ±</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="uploaded_${index}" ${status.uploaded ? "checked" : ""}>
                  <label class="form-check-label" for="uploaded_${index}">â˜ï¸ ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ù„Ù‚Ø©</label>
                </div>
              </div>
            </div>
          `;

          container.appendChild(col);
        });
      });
    });
  }

  // Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø­ÙØ¸"
  document.getElementById("editorForm").addEventListener("submit", (e) => {
    e.preventDefault();

    entriesArray.forEach((entry, index) => {
      const edited   = document.getElementById(`edited_${index}`).checked;
      const filmed   = document.getElementById(`filmed_${index}`).checked;
      const uploaded = document.getElementById(`uploaded_${index}`).checked;
      const editor   = document.getElementById(`editor_${index}`).value || "";

      const statusRef = db.ref(`editingStatus/${currentDate}/${entry.key}`);

      statusRef.set({
        name: entry.name || "",
        timeIn: entry.timeIn || "",
        timeOut: entry.timeOut || "",
        edited,
        filmed,
        uploaded,
        editor
      }).catch(error => {
        console.error("âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸:", error);
      });
    });

    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
  });
</script>

</body>
</html>
