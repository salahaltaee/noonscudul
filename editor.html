<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إدارة الحالة - المونتير</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <h3 class="text-center mb-4">🎬 صفحة المونتير - حالة الحلقات</h3>

  <!-- اختيار التاريخ -->
  <div class="mb-4">
    <label for="dateSelect" class="form-label">📅 اختر تاريخ:</label>
    <input type="date" id="dateSelect" class="form-control" onchange="loadDayData()">
  </div>

  <!-- قائمة الأساتذة حسب التاريخ -->
  <form id="editorForm" class="d-none">
    <div class="row g-3" id="editorList"></div>
    <div class="text-center mt-4">
      <button class="btn btn-primary">💾 حفظ الحالة</button>
    </div>
  </form>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBvNRBl3cObiLC7GufXyCnF6BlKLM3oWXw",
    authDomain: "register-app-534bf.firebaseapp.com",
    databaseURL: "https://register-app-534bf-default-rtdb.firebaseio.com",
    projectId: "register-app-534bf",
    projectNumber: "1042312911162"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let entriesArray = [];
  let currentDate = "";

  function loadDayData() {
    currentDate = document.getElementById("dateSelect").value;
    document.getElementById("editorForm").classList.remove("d-none");
    entriesArray = [];

    db.ref(`attendance/${currentDate}`).once("value", snapshot => {
      const data = snapshot.val();
      const container = document.getElementById("editorList");
      container.innerHTML = "";

      if (!data) {
        container.innerHTML = `<p class="text-muted text-center">لا يوجد حضور في هذا اليوم.</p>`;
        return;
      }

      Object.entries(data).forEach(([key, entry], index) => {
        entriesArray.push({ key, ...entry });

        db.ref(`editingStatus/${currentDate}/${key}`).once("value", statusSnap => {
          const status = statusSnap.val() || {};
          const col = document.createElement("div");
          col.className = "col-md-6";

          col.innerHTML = `
            <div class="card shadow-sm">
              <div class="card-body">
                <h5 class="card-title">${entry.name}</h5>
                <p class="card-text">⏰ دخول: ${entry.timeIn || "-"} - 🚪 خروج: ${entry.timeOut || "-"}</p>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="edited_${index}" ${status.edited ? "checked" : ""}>
                  <label class="form-check-label" for="edited_${index}">✅ تمت المنتجة</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="filmed_${index}" ${status.filmed ? "checked" : ""}>
                  <label class="form-check-label" for="filmed_${index}">🎥 تم التصوير</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="uploaded_${index}" ${status.uploaded ? "checked" : ""}>
                  <label class="form-check-label" for="uploaded_${index}">☁️ تم رفع الحلقة</label>
                </div>
              </div>
            </div>
          `;

          container.appendChild(col);
        });
      });
    });
  }

  // عند الضغط على "حفظ"
  document.getElementById("editorForm").addEventListener("submit", (e) => {
    e.preventDefault();

    entriesArray.forEach((entry, index) => {
      const edited = document.getElementById(`edited_${index}`).checked;
      const filmed = document.getElementById(`filmed_${index}`).checked;
      const uploaded = document.getElementById(`uploaded_${index}`).checked;

      const statusRef = db.ref(`editingStatus/${currentDate}/${entry.key}`);

      statusRef.set({
        name: entry.name || "",
        timeIn: entry.timeIn || "",
        timeOut: entry.timeOut || "",
        edited,
        filmed,
        uploaded
      }).catch(error => {
        console.error("❌ خطأ بالحفظ:", error);
      });
    });

    alert("✅ تم حفظ الحالة بنجاح!");
  });
</script>

</body>
</html>
