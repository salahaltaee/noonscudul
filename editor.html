<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة المونتير</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
  <h3 class="text-center mb-4">🎬 لوحة المونتير – حضور البارحة</h3>
  <form id="editorForm">
    <div id="editorList" class="row g-3"></div>
    <div class="text-center mt-4">
      <button type="submit" class="btn btn-success">💾 حفظ الحالة</button>
    </div>
  </form>
</div>

<script>
  const config = {
    apiKey: "AIzaSyBvNRBl3cObiLC7GufXyCnF6BlKLM3oWXw",
    authDomain: "register-app-534bf.firebaseapp.com",
    databaseURL: "https://register-app-534bf-default-rtdb.firebaseio.com",
    projectId: "register-app-534bf",
    projectNumber: "1042312911162"
  };

  firebase.initializeApp(config);
  const db = firebase.database();

  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const baghdadDate = new Date(yesterday.toLocaleString("en-US", { timeZone: "Asia/Baghdad" }));
  const formattedDate = baghdadDate.toISOString().split("T")[0];

  let entriesArray = [];

  function loadEditorList() {
    db.ref(`attendance/${formattedDate}`).once("value", snapshot => {
      const data = snapshot.val();
      const container = document.getElementById("editorList");
      container.innerHTML = "";
      entriesArray = [];

      if (!data) {
        container.innerHTML = `<p class="text-muted text-center">لا يوجد حضور مسجل ليوم: ${formattedDate}</p>`;
        return;
      }

      Object.entries(data).forEach(([key, entry], index) => {
        entriesArray.push({ key, ...entry });

        const col = document.createElement("div");
        col.className = "col-md-6";
        col.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">${entry.name}</h5>
              <p class="card-text">⏰ دخول: ${entry.timeIn || "-"} - خروج: ${entry.timeOut || "-"}</p>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edited_${index}">
                <label class="form-check-label" for="edited_${index}">✅ تمت المنتجة</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filmed_${index}">
                <label class="form-check-label" for="filmed_${index}">🎥 تم التصوير</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="uploaded_${index}">
                <label class="form-check-label" for="uploaded_${index}">☁️ تم رفع الحلقة</label>
              </div>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    });
  }

  document.getElementById("editorForm").addEventListener("submit", (e) => {
    e.preventDefault();

    entriesArray.forEach((entry, index) => {
      const edited = document.getElementById(`edited_${index}`).checked;
      const filmed = document.getElementById(`filmed_${index}`).checked;
      const uploaded = document.getElementById(`uploaded_${index}`).checked;

      db.ref(`editingStatus/${entry.name}/${formattedDate}`).set({
        timeIn: entry.timeIn || "",
        timeOut: entry.timeOut || "",
        edited,
        filmed,
        uploaded
      });
    });

    alert("✅ تم حفظ الحالة بنجاح!");
  });

  loadEditorList();
</script>

</body>
</html>
