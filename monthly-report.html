<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ù…ÙØµÙ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4" id="reportContent">
  <h3 class="text-center mb-4">ğŸ“… ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ø´Ù‡Ø± <span id="monthName"></span></h3>
  <div id="detailedReport"></div>
</div>

<div class="container mt-4 text-center">
  <button onclick="generatePDF()" class="btn btn-outline-success me-2">ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF</button>
  <a href="dashboard.html" class="btn btn-secondary">â¬…ï¸ Ø±Ø¬ÙˆØ¹</a>
</div>

<script>
  const config = {
    apiKey: "AIzaSyBvNRBl3cObiLC7GufXyCnF6BlKLM3oWXw",
    authDomain: "register-app-534bf.firebaseapp.com",
    databaseURL: "https://register-app-534bf-default-rtdb.firebaseio.com",
    projectId: "register-app-534bf",
    projectNumber: "1042312911162"
  };

  firebase.initializeApp(config);
  const db = firebase.database();

  const now = new Date();
  const baghdadNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Baghdad" }));
  const thisMonth = baghdadNow.toISOString().slice(0, 7);

  document.getElementById("monthName").textContent = baghdadNow.toLocaleString("ar-EG", {
    month: "long",
    year: "numeric",
    timeZone: "Asia/Baghdad"
  });

  function loadDetailedMonthlyReport() {
    db.ref("attendance").once("value", snapshot => {
      const data = snapshot.val();
      const report = {};

      if (!data) return;

      Object.entries(data).forEach(([date, entries]) => {
        if (date.startsWith(thisMonth)) {
          Object.values(entries).forEach(entry => {
            const { name, timeIn = "ØºÙŠØ± Ù…Ø³Ø¬Ù„", timeOut = "ØºÙŠØ± Ù…Ø³Ø¬Ù„" } = entry;
            if (!report[name]) report[name] = [];
            report[name].push({ date, timeIn, timeOut });
          });
        }
      });

      const container = document.getElementById("detailedReport");
      container.innerHTML = "";

      if (Object.keys(report).length === 0) {
        container.innerHTML = "<p class='text-muted text-center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</p>";
        return;
      }

      Object.entries(report)
        .sort((a, b) => b[1].length - a[1].length)
        .forEach(([name, visits]) => {
          const card = document.createElement("div");
          card.className = "card mb-4";
          card.innerHTML = `
            <div class="card-header bg-primary text-white">
              <strong>${name}</strong> - ${visits.length} Ø²ÙŠØ§Ø±Ø©
            </div>
            <div class="card-body p-0">
              <table class="table table-striped mb-0">
                <thead class="table-light">
                  <tr><th>ğŸ“† Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ğŸ•’ Ø¯Ø®ÙˆÙ„</th><th>ğŸ•” Ø®Ø±ÙˆØ¬</th></tr>
                </thead>
                <tbody>
                  ${visits.map(v => `<tr><td>${v.date}</td><td>${v.timeIn}</td><td>${v.timeOut}</td></tr>`).join("")}
                </tbody>
              </table>
            </div>`;
          container.appendChild(card);
        });
    });
  }

  function generatePDF() {
    const content = document.getElementById("reportContent");
    const opt = {
      margin: 0.5,
      filename: 'ØªÙ‚Ø±ÙŠØ±_Ø´Ù‡Ø±ÙŠ_Ù…ÙØµÙ„.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().from(content).set(opt).save();
  }

  loadDetailedMonthlyReport();
</script>

</body>
</html>
